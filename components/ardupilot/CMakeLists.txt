# ArduPilot Unified Component
# Auto-collects all libraries and Rover code

# ============================================================================
# Collect all source files using GLOB
# ============================================================================

# Collect all C/C++ files from libraries
file(GLOB_RECURSE ALL_LIBRARY_SRCS
    "../../libraries/*.c"
    "../../libraries/*.cpp"
)

# Collect all C/C++ files from Rover
file(GLOB_RECURSE ALL_ROVER_SRCS
    "../../Rover/*.c"
    "../../Rover/*.cpp"
)

# ===========================================================================
# DroneCAN libcanard core library and generated message code
# ===========================================================================

# libcanard core library
file(GLOB LIBCANARD_SRCS
    "../../modules/DroneCAN/libcanard/canard.c"
)

# DroneCAN generated message implementation files (generated by pre-build script)
file(GLOB_RECURSE DRONECAN_GENERATED_SRCS
    "../../libraries/AP_DroneCAN/src/*.c"
)

# Count the source files for diagnostics
list(LENGTH LIBCANARD_SRCS libcanard_count)
list(LENGTH DRONECAN_GENERATED_SRCS dronecan_gen_count)
message(STATUS "DroneCAN: Found ${libcanard_count} libcanard sources")
message(STATUS "DroneCAN: Found ${dronecan_gen_count} generated sources")

# Combine all sources
set(COMPONENT_SRCS ${ALL_LIBRARY_SRCS} ${ALL_ROVER_SRCS} ${LIBCANARD_SRCS} ${DRONECAN_GENERATED_SRCS})

# ============================================================================
# Exclude irrelevant files for ESP32
# ============================================================================

# Exclude non-ESP32 HALs
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_HAL_SITL/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_HAL_Empty/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_IOMCU/.*\\.(c|cpp)$")

# Exclude SITL-only files
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/SITL/.*\\.(c|cpp)$")

# Exclude benchmarks and examples
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/benchmarks/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/examples/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/Models/.*\\.(c|cpp)$")

# Exclude test files
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/tests/.*\\.(c|cpp)$")

# Exclude user-specified unwanted libraries
# NOTE: AP_Airspeed is KEPT - contains AP_Airspeed_DroneCAN backend used by AP_DroneCAN
# list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Airspeed/.*\\.(c|cpp)$")  # DISABLED - breaks DroneCAN
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_VisualOdom/.*\\.(c|cpp)$")

# ============================================================================
# Stage 1 Optimization: Remove definitely unnecessary libraries
# ============================================================================

# Aircraft-specific libraries (Rover never uses these)
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_LandingGear/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Parachute/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Soaring/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_TECS/.*\\.(c|cpp)$")

# Inapplicable sensors/devices for USV
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_VideoTX/.*\\.(c|cpp)$")
# list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_IRLock/.*\\.(c|cpp)$")  # Restored: needed by AC_PrecLand for Dock mode
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_GyroFFT/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Quicktune/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Scripting/.*\\.(c|cpp)$")

# NOTE: Special ESC drivers (KDECAN, PiccoloCAN, BLHeli, FETtec, Robotis) are KEPT
# Reason: Marine environment may require specialized waterproof/high-power ESCs

# Aviation-specific functions
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_ADSB/.*\\.(c|cpp)$")
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Generator/.*\\.(c|cpp)$")
# NOTE: AP_EFI is KEPT - contains AP_EFI_DroneCAN backend used by AP_DroneCAN
# list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_EFI/.*\\.(c|cpp)$")  # DISABLED - breaks DroneCAN

# Uncommon telemetry protocols
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Devo_Telem/.*\\.(c|cpp)$")

# ============================================================================
# Stage 2 Optimization (Partial): Remove confirmed unnecessary sensors
# ============================================================================

# Sensors not needed for outdoor GPS-based USV navigation
# NOTE: AP_OpticalFlow is KEPT - contains AP_OpticalFlow_HereFlow backend used by AP_DroneCAN
# list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_OpticalFlow/.*\\.(c|cpp)$")  # DISABLED - breaks DroneCAN
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AP_Beacon/.*\\.(c|cpp)$")

# Exclude all AC_* modules first (will re-add required ones below)
list(FILTER COMPONENT_SRCS EXCLUDE REGEX ".*/AC_[^/]+/.*\\.(c|cpp)$")

# ============================================================================
# Re-add required modules
# ============================================================================

# AC_ modules required by Rover (only 4 modules actually used)
set(ROVER_REQUIRED_AC_MODULES
    AC_PosControl     # Position controller helpers used by AR_PosControl
    AC_PID           # Core PID controllers (includes AC_P/AC_PI helpers)
    AC_AttitudeControl  # Provides AC_PosControl logging helpers and related utilities
    AC_Fence          # Geofence system
    AC_Avoidance      # Obstacle avoidance
    AC_Sprayer        # Sprayer control
    AC_PrecLand       # Precision landing (minimal use in Rover)
)

foreach(ac_module IN LISTS ROVER_REQUIRED_AC_MODULES)
    file(GLOB_RECURSE ac_module_srcs
        "../../libraries/${ac_module}/*.c"
        "../../libraries/${ac_module}/*.cpp"
    )
    list(APPEND COMPONENT_SRCS ${ac_module_srcs})
endforeach()

# Re-add essential HAL files for build system
file(GLOB HAL_EMPTY_SRCS "../../libraries/AP_HAL_Empty/*.cpp")
file(GLOB HAL_ESP32_SRCS "../../libraries/AP_HAL_ESP32/*.cpp" "../../libraries/AP_HAL_ESP32/*.c")

# NOTE: SITL (Software In The Loop) is NOT needed for ESP32 hardware firmware
# SITL is only for PC-based simulation, not for actual hardware deployment
# Commented out to fix compilation errors from incomplete SITL framework
#
# file(GLOB HAL_SITL_ESSENTIAL
#     "../../libraries/AP_HAL_SITL/sitl_airspeed.cpp"
#     "../../libraries/AP_HAL_SITL/SITL_cmdline.cpp"
#     "../../libraries/AP_HAL_SITL/SITL_Periph_State.cpp"
#     "../../libraries/AP_HAL_SITL/sitl_rangefinder.cpp"
#     "../../libraries/AP_HAL_SITL/SITL_State.cpp"
#     "../../libraries/AP_HAL_SITL/SITL_State_common.cpp"
# )

list(APPEND COMPONENT_SRCS ${HAL_EMPTY_SRCS})
list(APPEND COMPONENT_SRCS ${HAL_ESP32_SRCS})
# list(APPEND COMPONENT_SRCS ${HAL_SITL_ESSENTIAL})  # Disabled for ESP32

# NOTE: SITL simulator files are NOT needed for ESP32 hardware
# These files (ServoModel, SIM_Rover, etc.) require complete SITL framework
# which includes Aircraft base class and full simulation infrastructure
# ESP32 runs on real hardware, not simulation
#
# file(GLOB SITL_ESSENTIAL_SRCS
#     "../../libraries/SITL/ServoModel.cpp"
#     "../../libraries/SITL/SIM_Rover.cpp"
#     "../../libraries/SITL/SIM_Sailboat.cpp"
#     "../../libraries/SITL/SITL.cpp"
# )
# list(APPEND COMPONENT_SRCS ${SITL_ESSENTIAL_SRCS})  # Disabled for ESP32

# ============================================================================
# Include directories
# ============================================================================

set(COMPONENT_ADD_INCLUDEDIRS
    "../../Rover"
    "../../libraries"
    "../../libraries/APM_Control"
    "../../libraries/AP_ADC"
    "../../libraries/AP_ADSB"
    "../../libraries/AP_AHRS"
    "../../libraries/AP_AIS"
    "../../libraries/AP_AccelCal"
    "../../libraries/AP_AdvancedFailsafe"
    "../../libraries/AP_Arming"
    "../../libraries/AP_Avoidance"
    "../../libraries/AP_BLHeli"
    "../../libraries/AP_Baro"
    "../../libraries/AP_BattMonitor"
    "../../libraries/AP_Beacon"
    "../../libraries/AP_BoardConfig"
    "../../libraries/AP_Button"
    "../../libraries/AP_CANManager"
    "../../libraries/AP_CSVReader"
    "../../libraries/AP_Camera"
    "../../libraries/AP_CheckFirmware"
    "../../libraries/AP_Common"
    "../../libraries/AP_Common/missing"
    "../../libraries/AP_Compass"
    "../../libraries/AP_CustomRotations"
    "../../libraries/AP_DAC"
    "../../libraries/AP_DAL"
    "../../libraries/AP_DDS"
    "../../libraries/AP_Declination"
    "../../libraries/AP_Devo_Telem"
    "../../libraries/AP_DroneCAN"
    "../../libraries/AP_EFI"
    "../../libraries/AP_ESC_Telem"
    "../../libraries/AP_ExternalAHRS"
    "../../libraries/AP_ExternalControl"
    "../../libraries/AP_FETtecOneWire"
    "../../libraries/AP_Filesystem"
    "../../libraries/AP_FlashIface"
    "../../libraries/AP_FlashStorage"
    "../../libraries/AP_Follow"
    "../../libraries/AP_Frsky_Telem"
    "../../libraries/AP_GPS"
    "../../libraries/AP_GSOF"
    "../../libraries/AP_Generator"
    "../../libraries/AP_Gripper"
    "../../libraries/AP_HAL"
    "../../libraries/AP_HAL_ESP32"
    "../../libraries/AP_HAL_ESP32/hwdef"
    "../../libraries/AP_HAL_Empty"
    # "../../libraries/AP_HAL_SITL"  # Disabled: SITL not needed for ESP32 hardware
    "../../libraries/AP_Hott_Telem"
    "../../libraries/AP_IBus_Telem"
    "../../libraries/AP_ICEngine"
    "../../libraries/AP_IOMCU"
    "../../libraries/AP_IRLock"
    "../../libraries/AP_InertialNav"
    "../../libraries/AP_InertialSensor"
    "../../libraries/AP_InternalError"
    "../../libraries/AP_JSButton"
    "../../libraries/AP_JSON"
    "../../libraries/AP_KDECAN"
    "../../libraries/AP_L1_Control"
    "../../libraries/AP_LTM_Telem"
    "../../libraries/AP_Landing"
    "../../libraries/AP_LandingGear"
    "../../libraries/AP_LeakDetector"
    "../../libraries/AP_LightWareSerial"
    "../../libraries/AP_Logger"
    "../../libraries/AP_MSP"
    "../../libraries/AP_Math"
    "../../libraries/AP_Menu"
    "../../libraries/AP_Mission"
    "../../libraries/AP_Module"
    "../../libraries/AP_Motors"
    "../../libraries/AP_Mount"
    "../../libraries/AP_MultiHeap"
    "../../libraries/AP_NMEA_Output"
    "../../libraries/AP_NavEKF"
    "../../libraries/AP_NavEKF2"
    "../../libraries/AP_NavEKF3"
    "../../libraries/AP_Navigation"
    "../../libraries/AP_Networking"
    "../../libraries/AP_Notify"
    "../../libraries/AP_OLC"
    "../../libraries/AP_ONVIF"
    "../../libraries/AP_OSD"
    "../../libraries/AP_OpenDroneID"
    "../../libraries/AP_OpticalFlow"
    "../../libraries/AP_Parachute"
    "../../libraries/AP_Param"
    "../../libraries/AP_PiccoloCAN"
    "../../libraries/AP_Proximity"
    "../../libraries/AP_Quicktune"
    "../../libraries/AP_RAMTRON"
    "../../libraries/AP_RCMapper"
    "../../libraries/AP_RCProtocol"
    "../../libraries/AP_RCTelemetry"
    "../../libraries/AP_ROMFS"
    "../../libraries/AP_RPM"
    "../../libraries/AP_RSSI"
    "../../libraries/AP_RTC"
    "../../libraries/AP_Radio"
    "../../libraries/AP_Rally"
    "../../libraries/AP_RangeFinder"
    "../../libraries/AP_Relay"
    "../../libraries/AP_RobotisServo"
    "../../libraries/AP_SBusOut"
    "../../libraries/AP_Scheduler"
    "../../libraries/AP_Scripting"
    "../../libraries/AP_SerialLED"
    "../../libraries/AP_SerialManager"
    "../../libraries/AP_ServoRelayEvents"
    "../../libraries/AP_Servo_Telem"
    "../../libraries/AP_SmartRTL"
    "../../libraries/AP_Soaring"
    "../../libraries/AP_Stats"
    "../../libraries/AP_SurfaceDistance"
    "../../libraries/AP_TECS"
    "../../libraries/AP_TempCalibration"
    "../../libraries/AP_TemperatureSensor"
    "../../libraries/AP_Terrain"
    "../../libraries/AP_Torqeedo"
    "../../libraries/AP_Tuning"
    "../../libraries/AP_Vehicle"
    "../../libraries/AP_VideoTX"
    "../../libraries/AP_Volz_Protocol"
    "../../libraries/AP_WheelEncoder"
    "../../libraries/AP_Winch"
    "../../libraries/AP_WindVane"
    "../../libraries/AR_Motors"
    "../../libraries/AR_WPNav"
    "../../libraries/Filter"
    "../../libraries/GCS_MAVLink"
    "../../libraries/PID"
    "../../libraries/RC_Channel"
    # "../../libraries/SITL"  # Disabled: SITL not needed for ESP32 hardware
    "../../libraries/SRV_Channel"
    "../../libraries/StorageManager"
    "../../libraries/doc"
)

# Exclude AC_* include directories from global include path
list(FILTER COMPONENT_ADD_INCLUDEDIRS EXCLUDE REGEX ".*/AC_[^/]+$")

# Re-add required AC_ module include directories
foreach(ac_module IN LISTS ROVER_REQUIRED_AC_MODULES)
    list(APPEND COMPONENT_ADD_INCLUDEDIRS "../../libraries/${ac_module}")
endforeach()

# Add DroneCAN libcanard include paths
list(APPEND COMPONENT_ADD_INCLUDEDIRS "../../modules/DroneCAN/libcanard")
list(APPEND COMPONENT_ADD_INCLUDEDIRS "../../libraries/AP_DroneCAN/include")

# Remove duplicates
list(REMOVE_DUPLICATES COMPONENT_ADD_INCLUDEDIRS)

# ============================================================================
# Register component
# ============================================================================

idf_component_register(
    SRCS ${COMPONENT_SRCS}
    INCLUDE_DIRS "."
    REQUIRES
        freertos
        esp_timer
        driver
        esp_wifi
        lwip
        nvs_flash
        spi_flash
        app_update
        fatfs
        esp_adc
        esp_driver_mcpwm
        esp_system
        esp_rom
)

# Append ArduPilot paths after IDF/toolchain dirs (matching upstream waf)
target_include_directories(${COMPONENT_LIB} PUBLIC ${COMPONENT_ADD_INCLUDEDIRS})

# ============================================================================
# Compile options
# ============================================================================

target_compile_options(${COMPONENT_LIB} PRIVATE
    -fsingle-precision-constant
    -Wno-error=format
    -Wno-format-security
    -Wno-error=unused-variable
    -Wno-error=unused-but-set-variable
    -Wno-error=maybe-uninitialized
    -Wno-error=trigraphs
    -Wno-trigraphs
)

# ============================================================================
# Definitions
# ============================================================================

target_compile_definitions(${COMPONENT_LIB} PUBLIC
    CONFIG_HAL_BOARD=HAL_BOARD_ESP32
    APM_BUILD_DIRECTORY=APM_BUILD_Rover
    __AP_LINE__=__LINE__

    # DroneCAN support
    USE_USER_HELPERS             # Enable Canard::Semaphore typedef
    DRONECAN_CXX_WRAPPERS        # Enable DroneCAN C++ wrapper API

    # libcanard configuration (CRITICAL for ESP32 DroneCAN support)
    CANARD_ENABLE_DEADLINE=1     # Enable deadline_usec field in CanardTxTransfer and CanardCANFrame
    CANARD_MULTI_IFACE=1         # Enable iface_mask field for multi-interface CAN support
    CANARD_ALLOCATE_SEM=1        # Enable semaphore allocation callbacks for thread safety

    # Previously disabled features
    HAL_AIRSPEED_ENABLED=0
    HAL_VISUALODOM_ENABLED=0

    # Stage 1 Optimization: Disable aircraft-specific features
    HAL_PARACHUTE_ENABLED=0
    HAL_LANDING_GEAR_ENABLED=0
    HAL_SOARING_ENABLED=0
    AP_ADVANCEDFAILSAFE_ENABLED=0

    # Disable inapplicable sensors/devices
    AP_VIDEOTX_ENABLED=0
    # AP_IRLOCK_ENABLED=0  # Restored: needed by AC_PrecLand for Dock mode
    HAL_GYROFFT_ENABLED=0

    # Disable aviation-specific functions
    HAL_ADSB_ENABLED=0
    HAL_GENERATOR_ENABLED=0
    HAL_EFI_ENABLED=0

    # Stage 2 Partial: Disable confirmed unnecessary sensors
    HAL_OPTICALFLOW_ENABLED=0
    HAL_BEACON_ENABLED=0
)
