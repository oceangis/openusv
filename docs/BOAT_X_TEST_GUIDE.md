# X型船改进测试指南

## 文档信息
- **创建日期**: 2025-11-09
- **测试对象**: FRAME_TYPE_BOAT_VECTORED_X lateral因子修正
- **测试环境**: ESP32-S3 + 4个推进器

---

## 测试前准备

### 硬件连接
```
ESP32-S3 USV 推进器连接：
┌────────┬──────┬─────────┬──────────┐
│ 推进器 │ 位置 │ 舵机通道 │ GPIO引脚 │
├────────┼──────┼─────────┼──────────┤
│ M1     │ 左前 │ SRV1    │ GPIO XX  │
│ M2     │ 右前 │ SRV2    │ GPIO XX  │
│ M3     │ 左后 │ SRV3    │ GPIO XX  │
│ M4     │ 右后 │ SRV4    │ GPIO XX  │
└────────┴──────┴─────────┴──────────┘
```

### 参数设置
```ini
# 基本配置
FRAME_CLASS = 2              # 水面船只
FRAME_TYPE = 11              # BoatVectoredX

# 电机通道映射（根据实际硬件调整）
SERVO1_FUNCTION = 33         # Motor1
SERVO2_FUNCTION = 34         # Motor2
SERVO3_FUNCTION = 35         # Motor3
SERVO4_FUNCTION = 36         # Motor4

# 推进器方向（根据实际安装调整）
# 正转应该使船体按预期方向运动
SERVO1_REVERSED = 0          # Motor1 (调整到正转=向右前推)
SERVO2_REVERSED = 0          # Motor2 (调整到正转=向左前推)
SERVO3_REVERSED = 0          # Motor3 (调整到正转=向右后推)
SERVO4_REVERSED = 0          # Motor4 (调整到正转=向左后推)

# 控制参数
CRUISE_SPEED = 2.0           # 巡航速度 (m/s)
CRUISE_THROTTLE = 50         # 巡航油门 (%)
```

### 安全检查清单
- [ ] 推进器固定牢固
- [ ] 电源电压正常（12V/24V）
- [ ] 急停按钮可用
- [ ] 测试水域安全（无障碍物）
- [ ] 遥控器范围内（<100m）
- [ ] 地面站连接正常

---

## 第一阶段：单电机功能测试

### Test 1.1: Motor 1 (左前) 单独测试

**目的**: 验证M1推进器方向和PWM响应

**步骤**:
1. 进入 Manual 模式
2. 设置 `RC3=1500` (油门中位)
3. 地面站发送命令：`DO_MOTOR_TEST 1 50 0 0`（M1正转50%）
4. 观察推进器转向和船体反应

**预期结果**:
- M1推进器正转（顺时针/逆时针取决于安装）
- 推力方向：**向右前45°**
- 船体反应：轻微向左后移动

**如果反向**: 设置 `SERVO1_REVERSED=1`

---

### Test 1.2: Motor 2 (右前) 单独测试

**步骤**:
1. 地面站发送命令：`DO_MOTOR_TEST 2 50 0 0`（M2正转50%）
2. 观察推进器转向和船体反应

**预期结果**:
- M2推进器正转
- 推力方向：**向左前45°**
- 船体反应：轻微向右后移动

**如果反向**: 设置 `SERVO2_REVERSED=1`

---

### Test 1.3: Motor 3 (左后) 单独测试

**步骤**:
1. 地面站发送命令：`DO_MOTOR_TEST 3 50 0 0`（M3正转50%）
2. 观察推进器转向和船体反应

**预期结果**:
- M3推进器正转
- 推力方向：**向右后45°**
- 船体反应：轻微向左前移动

**如果反向**: 设置 `SERVO3_REVERSED=1`

---

### Test 1.4: Motor 4 (右后) 单独测试

**步骤**:
1. 地面站发送命令：`DO_MOTOR_TEST 4 50 0 0`（M4正转50%）
2. 观察推进器转向和船体反应

**预期结果**:
- M4推进器正转
- 推力方向：**向左后45°**
- 船体反应：轻微向右前移动

**如果反向**: 设置 `SERVO4_REVERSED=1`

---

## 第二阶段：基础运动测试

### Test 2.1: Pure Forward（纯前进）

**目的**: 验证throttle因子正确性

**步骤**:
1. 进入 Manual 模式
2. 设置摇杆：`Throttle=+50%`, `Steering=0`, `Lateral=0`
3. 观察船体运动10秒
4. 记录GPS航迹和罗盘航向变化

**预期结果**:
```
电机输出（理论值）:
M1 (左前): +50 * 0.707 = +35.4%
M2 (右前): +50 * 0.707 = +35.4%
M3 (左后): +50 * -0.707 = -35.4%
M4 (右后): +50 * -0.707 = -35.4%

船体运动:
- 方向：正前方（0°偏差）
- 速度：约1-2 m/s
- 偏航：无（航向保持稳定）
- 横移：无（GPS航迹直线）
```

**判断标准**:
- ✅ **通过**: 航向偏差 < ±5°，横移 < 0.5m
- ❌ **失败**: 航向偏差 > ±10° 或 明显横移

**如果失败**:
- 检查M1/M2的throttle因子是否为 +0.707
- 检查M3/M4的throttle因子是否为 -0.707
- 检查推进器安装角度是否为45°

---

### Test 2.2: Pure Yaw CW（纯顺时针旋转）

**目的**: 验证steering因子正确性

**步骤**:
1. 设置摇杆：`Throttle=0`, `Steering=+50%`, `Lateral=0`
2. 观察船体旋转10秒
3. 记录罗盘航向变化率

**预期结果**:
```
电机输出（理论值）:
M1 (左前): +50 * -0.707 = -35.4%
M2 (右前): +50 * 0.707 = +35.4%
M3 (左后): +50 * -0.707 = -35.4%
M4 (右后): +50 * 0.707 = +35.4%

船体运动:
- 旋转方向：顺时针（航向增加）
- 旋转速度：约20-40°/秒
- 平移：无（GPS位置保持）
- 前进/后退：无
```

**判断标准**:
- ✅ **通过**: GPS位移 < 1m，纯旋转无平移
- ❌ **失败**: GPS位移 > 2m 或 前进/后退

**如果失败**:
- 检查左侧(M1,M3)的steering因子是否为 -0.707
- 检查右侧(M2,M4)的steering因子是否为 +0.707

---

### Test 2.3: Pure Lateral Right（纯向右横移） - 关键测试！

**目的**: 验证lateral因子修正是否正确（这是本次改进的核心！）

**步骤**:
1. 设置摇杆：`Throttle=0`, `Steering=0`, `Lateral=+50%`
2. **重要**: 用相机/手机录制船体运动
3. 观察船体运动10秒
4. 记录GPS航迹和罗盘航向变化

**预期结果（修改后）**:
```
电机输出（理论值）:
M1 (左前): +50 * 0.707 = +35.4%  ← FIXED
M2 (右前): +50 * -0.707 = -35.4% ← FIXED
M3 (左后): +50 * 0.707 = +35.4%
M4 (右后): +50 * -0.707 = -35.4%

船体运动:
- 方向：纯右移（GPS航迹向右）
- 速度：约0.5-1 m/s
- 偏航：无！（航向保持不变）← 关键指标！
- 前进/后退：无
```

**判断标准**:
- ✅ **通过**: 航向偏差 < ±5°，纯横移无旋转
- ❌ **失败**: 航向偏差 > ±10° 或 同时旋转

**对比测试（修改前 vs 修改后）**:

| 项目 | 修改前（错误） | 修改后（正确） |
|------|---------------|---------------|
| M1输出 | -35.4% (推) | +35.4% (拉) |
| M2输出 | +35.4% (拉) | -35.4% (推) |
| M3输出 | +35.4% (拉) | +35.4% (拉) |
| M4输出 | -35.4% (推) | -35.4% (推) |
| 运动结果 | **横移+旋转** | **纯横移** |
| 航向变化 | **±20-30°** | **< ±5°** |

**如果失败（仍然有旋转）**:
- 说明lateral因子未正确修改！
- 检查代码是否应用：
  ```cpp
  add_omni_motor(0, cos45, -cos45, cos45);  // M1: lateral=+cos45
  add_omni_motor(1, cos45, cos45, -cos45);  // M2: lateral=-cos45
  ```
- 重新编译和刷写固件

---

### Test 2.4: Pure Lateral Left（纯向左横移）

**步骤**:
1. 设置摇杆：`Throttle=0`, `Steering=0`, `Lateral=-50%`
2. 观察船体运动10秒

**预期结果**:
```
电机输出（理论值）:
M1 (左前): -50 * 0.707 = -35.4%
M2 (右前): -50 * -0.707 = +35.4%
M3 (左后): -50 * 0.707 = -35.4%
M4 (右后): -50 * -0.707 = +35.4%

船体运动:
- 方向：纯左移（GPS航迹向左）
- 航向：无变化（< ±5°）
```

---

## 第三阶段：组合运动测试

### Test 3.1: Forward + Yaw（前进+右转）

**目的**: 验证throttle和steering混合正确

**步骤**:
1. 设置摇杆：`Throttle=+50%`, `Steering=+50%`, `Lateral=0`
2. 观察船体运动（应该像汽车右转）

**预期结果**:
```
电机输出（理论值）:
M1: (+50*0.707) + (+50*-0.707) = 0%
M2: (+50*0.707) + (+50*0.707) = +70.7%
M3: (+50*-0.707) + (+50*-0.707) = -70.7%
M4: (+50*-0.707) + (+50*0.707) = 0%

船体运动:
- 路径：圆弧向右
- M2推，M3拉，M1/M4停止
```

---

### Test 3.2: Forward + Lateral（前进+右移）→ 右前45°

**目的**: 验证对角线运动（X型最高效）

**步骤**:
1. 设置摇杆：`Throttle=+50%`, `Steering=0`, `Lateral=+50%`
2. 观察船体运动方向

**预期结果（修改后）**:
```
电机输出（理论值）:
M1: (+50*0.707) + (+50*0.707) = +70.7%
M2: (+50*0.707) + (+50*-0.707) = 0%
M3: (+50*-0.707) + (+50*0.707) = 0%
M4: (+50*-0.707) + (+50*-0.707) = -70.7%

船体运动:
- 方向：右前45°
- 推进器：仅M1推，M4拉（最高效）
- GPS航迹：直线向右前
```

**这是X型配置的优势！对角线运动最高效！**

---

### Test 3.3: Yaw + Lateral（旋转+横移）

**目的**: 验证复杂组合

**步骤**:
1. 设置摇杆：`Throttle=0`, `Steering=+50%`, `Lateral=+50%`
2. 观察船体运动

**预期结果（修改后）**:
```
电机输出（理论值）:
M1: (+50*-0.707) + (+50*0.707) = 0%
M2: (+50*0.707) + (+50*-0.707) = 0%
M3: (+50*-0.707) + (+50*0.707) = 0%
M4: (+50*0.707) + (+50*-0.707) = 0%

船体运动:
- 所有电机为0！
- 说明：Yaw和Lateral在X型配置下相互抵消
```

**这是正常现象！** X型的Yaw和Lateral正交。

---

## 第四阶段：边界条件测试

### Test 4.1: Maximum Throttle（最大油门）

**步骤**:
1. 设置摇杆：`Throttle=+100%`, `Steering=0`, `Lateral=0`
2. 观察最大速度

**预期结果**:
```
电机输出:
M1/M2: +70.7% (前推进器)
M3/M4: -70.7% (后推进器)

船体运动:
- 最大速度：根据推进器规格
- 航向稳定
```

---

### Test 4.2: Saturation Test（饱和测试）

**步骤**:
1. 设置摇杆：`Throttle=+100%`, `Steering=+100%`, `Lateral=0`
2. 观察饱和归一化

**预期结果**:
```
原始输出:
M1: (+100*0.707) + (+100*-0.707) = 0%
M2: (+100*0.707) + (+100*0.707) = +141.4% → 饱和！
M3: (+100*-0.707) + (+100*-0.707) = -141.4% → 饱和！
M4: (+100*-0.707) + (+100*0.707) = 0%

归一化后 (除以1.414):
M1: 0%
M2: +100%
M3: -100%
M4: 0%

船体运动:
- 方向：前进+右转（按比例缩放）
- M2/M3全速，M1/M4停止
```

---

### Test 4.3: Reverse Test（倒车测试）

**步骤**:
1. 设置摇杆：`Throttle=-50%`, `Steering=0`, `Lateral=0`
2. 观察倒车

**预期结果**:
```
电机输出:
M1/M2: -35.4% (前推进器反转)
M3/M4: +35.4% (后推进器反转)

船体运动:
- 方向：后退
- 航向稳定
```

---

## 第五阶段：ArduSub对比测试

### Test 5.1: 与ArduSub VECTORED输出对比

**目的**: 验证Rover输出 ≈ ArduSub * 0.707

**步骤**:
1. Rover设置：`Throttle=+71%`, `Steering=0`, `Lateral=+71%`
2. 对应ArduSub：`forward=+1.0`, `yaw=0`, `lateral=+1.0`
3. 对比电机输出

**预期结果**:

| 电机 | ArduSub输出 | Rover输出（理论） | Rover输出（实际） | 误差 |
|------|------------|------------------|------------------|------|
| M1   | +100%      | +71*1.414=+100%  | ？               | ？   |
| M2   | 0%         | 0%               | ？               | ？   |
| M3   | 0%         | 0%               | ？               | ？   |
| M4   | -100%      | -100%            | ？               | ？   |

**判断**:
- ✅ **通过**: Rover输出 = ArduSub输出（在cos45=0.707归一化后）
- ❌ **失败**: 输出不一致

---

## 测试数据记录表

### 单因子测试记录

| Test | 命令 (T/S/L) | M1 | M2 | M3 | M4 | 航向变化 | GPS位移 | 结果 |
|------|-------------|----|----|----|----|---------|--------|------|
| 2.1  | 50/0/0      |    |    |    |    |         |        |      |
| 2.2  | 0/50/0      |    |    |    |    |         |        |      |
| 2.3  | 0/0/50      |    |    |    |    |         |        | ← 关键！ |
| 2.4  | 0/0/-50     |    |    |    |    |         |        |      |

### 组合运动测试记录

| Test | 命令 (T/S/L) | M1 | M2 | M3 | M4 | 运动描述 | 结果 |
|------|-------------|----|----|----|----|---------|------|
| 3.1  | 50/50/0     |    |    |    |    |         |      |
| 3.2  | 50/0/50     |    |    |    |    |         |      |
| 3.3  | 0/50/50     |    |    |    |    |         |      |

---

## 故障排查

### 问题1: Lateral仍然有旋转

**症状**: 设置Lateral=+100时，船体横移同时旋转

**原因**: lateral因子未正确修改

**解决**:
1. 检查代码：
   ```bash
   grep "add_omni_motor" libraries/AR_Motors/AP_MotorsUGV.cpp | grep "BOAT_VECTORED_X" -A 10
   ```
2. 应该看到：
   ```cpp
   add_omni_motor(0, cos45, -cos45, cos45);  // M1
   add_omni_motor(1, cos45, cos45, -cos45);  // M2
   ```
3. 如果不是，重新修改代码，重新编译

---

### 问题2: Forward有横移

**症状**: 设置Throttle=+100时，船体前进同时横移

**原因**: M1/M2推进器安装角度不对称

**解决**:
1. 检查推进器物理安装角度（应该对称45°）
2. 微调 `SERVO1_TRIM` 和 `SERVO2_TRIM`

---

### 问题3: Yaw不对称

**症状**: 左转和右转速度不一样

**原因**: 推进器推力不对称

**解决**:
1. 调整 `MOT_THST_ASYM` 参数
2. 校准ESC

---

## 成功标准

### 必须通过的测试
- ✅ Test 2.1 (Forward): 航向偏差 < ±5°
- ✅ Test 2.2 (Yaw): GPS位移 < 1m
- ✅ **Test 2.3 (Lateral Right): 航向偏差 < ±5°** ← 最关键！
- ✅ Test 2.4 (Lateral Left): 航向偏差 < ±5°
- ✅ Test 3.2 (Diagonal): 沿45°直线运动

### 可选测试
- Test 3.1 (Forward+Yaw): 圆弧路径
- Test 4.1 (Max Throttle): 最大速度
- Test 5.1 (ArduSub对比): 输出一致性

---

## 测试报告模板

```markdown
# X型船Lateral修正测试报告

## 测试信息
- 日期: YYYY-MM-DD
- 测试员: XXX
- 固件版本: vX.X
- 硬件版本: ESP32-S3 + 4xT200

## 测试结果总结
- [ ] Test 2.1 (Forward): PASS / FAIL
- [ ] Test 2.2 (Yaw): PASS / FAIL
- [ ] Test 2.3 (Lateral Right): PASS / FAIL ← 关键
- [ ] Test 2.4 (Lateral Left): PASS / FAIL
- [ ] Test 3.2 (Diagonal): PASS / FAIL

## 关键测试数据
Test 2.3 (Lateral Right, Throttle=0, Steering=0, Lateral=+100):
- M1输出: XXX%
- M2输出: XXX%
- M3输出: XXX%
- M4输出: XXX%
- 航向变化: XXX°
- GPS横移距离: XXX m
- 结论: 修正成功 / 修正失败

## 问题和建议
(记录测试中发现的问题)

## 结论
修改 [ ] 成功  [ ] 失败
```

---

## 附录：GCS命令速查

### Mission Planner
```
# 单电机测试
DO_MOTOR_TEST 1 50 0 0  # M1 50%
DO_MOTOR_TEST 2 50 0 0  # M2 50%
DO_MOTOR_TEST 3 50 0 0  # M3 50%
DO_MOTOR_TEST 4 50 0 0  # M4 50%

# 参数设置
PARAM_SET FRAME_TYPE 11
PARAM_WRITE

# 查看电机输出
SERVO_OUTPUT_RAW
```

### MAVProxy
```python
# 单电机测试
motor test 1 50
motor test 2 50
motor test 3 50
motor test 4 50

# 参数设置
param set FRAME_TYPE 11
param write
```

---

**文档版本**: v1.0
**作者**: ArduPilot ESP32-S3 Team
**日期**: 2025-11-09
**状态**: 待测试
